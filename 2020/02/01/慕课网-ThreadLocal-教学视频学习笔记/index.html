<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="个人公众号《骇客与画家》" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>慕课网 ThreadLocal 教学视频学习笔记 |  高行行的个人博客</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-慕课网-ThreadLocal-教学视频学习笔记"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  慕课网 ThreadLocal 教学视频学习笔记
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2020/02/01/%E6%85%95%E8%AF%BE%E7%BD%91-ThreadLocal-%E6%95%99%E5%AD%A6%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2020-01-31T16:33:30.000Z" itemprop="datePublished">2020-02-01</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">2.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">10 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p>课程地址：<a target="_blank" rel="noopener" href="https://www.imooc.com/learn/1217">https://www.imooc.com/learn/1217</a></p>
<p>作者：<a target="_blank" rel="noopener" href="https://www.imooc.com/u/6703917/courses?sort=publish">求老仙奶我不到 P10</a>（这昵称 🤔，我奶一口，你到不了 P10 🐶）</p>
<p>作者简介：我是一名有 10 年经验的互联网老兵，创过业、也曾任数家大型互联网公司架构师、团队 Leader，30 岁（2018）任职阿里巴巴高级技术专家（P8）。曾负责架构 PHP 高负载、前端（React&#x2F;RN）方向、Java 领域化中间件方向、大数据(BI 和数据可视化)等多方向业界知名项目。大学刷完算法导论，参加过 ACM 和国际机器人竞赛，多年在项目中实践技术驱动、前端后端领域化、数据可视化，多个领域实战经验丰富。</p>
<p>代码地址（跟着课程手敲的）：<a target="_blank" rel="noopener" href="https://github.com/gaohanghang/spring-threadlocal-demo">https://github.com/gaohanghang/spring-threadlocal-demo</a></p>
</blockquote>
<blockquote>
<p>简介：多线程增加了我们的不确定性，破坏了可预测性——当然，这对于【艺高人胆大】的未来的你，都是小事，因为你会不断进步成长，只要你把握好现在的光阴。科学的美，在于它的模型可以不断的迭代和进步，Java 是一种简化和进步，ThreadLocal 也一种简化和进步，如同 Java 给编程带来了很多安全感，而 ThreadLocal 给多线程时代带了更多的安全感（可预测性、确定性，一致性……）。课程是一种爬坡训练，难度会一直上去直到你完全理解，可以自己动手实现。</p>
</blockquote>
<h2 id="第-1-章-纵观课程纲要"><a href="#第-1-章-纵观课程纲要" class="headerlink" title="第 1 章 纵观课程纲要"></a>第 1 章 纵观课程纲要</h2><blockquote>
<p>了解一致性等基础概念，解决一致性的基本方法，把 ThreadLocal 放到一个宏观背景去思考。</p>
</blockquote>
<h3 id="1-1-论程序的安全感-09-09"><a href="#1-1-论程序的安全感-09-09" class="headerlink" title="1-1 论程序的安全感 (09:09)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21049">1-1 论程序的安全感 (09:09)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580489265125-61162927-4d88-40e2-9df2-8ff7170ee2d9.png"></p>
<p>改变思维方式</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580275962784-b45e6758-929b-4781-ae93-fa62fcc2bdc0.png#align=left&display=inline&height=627&name=image.png&originHeight=1254&originWidth=2232&size=271910&status=done&style=none&width=1116"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580275979974-aeb59c89-4af7-49f3-bec0-339fa7357845.png#align=left&display=inline&height=627&name=image.png&originHeight=1254&originWidth=2236&size=417984&status=done&style=none&width=1118"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580276010435-18c12c8d-09cc-4fe8-9432-d04f0bd0aa4f.png#align=left&display=inline&height=626&name=image.png&originHeight=1252&originWidth=2234&size=356979&status=done&style=none&width=1117"></p>
<p>Single Source Of Truth: 单一数据源</p>
<p>不断的解决数据不一致的问题</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580276117575-bf72a3c3-3b3c-4531-881f-2f21d8fed80a.png#align=left&display=inline&height=617&name=image.png&originHeight=1234&originWidth=2224&size=447585&status=done&style=none&width=1112"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580276289023-4bda0d52-a530-4848-9161-5a66fd9c11e0.png#align=left&display=inline&height=621&name=image.png&originHeight=1242&originWidth=2224&size=446544&status=done&style=none&width=1112"></p>
<h3 id="1-2-课程介绍-07-12"><a href="#1-2-课程介绍-07-12" class="headerlink" title="1-2 课程介绍 (07:12)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21050">1-2 课程介绍 (07:12)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580278369748-7882e0d6-eca7-4558-8d6c-93bb7cc2aad0.png#align=left&display=inline&height=692&name=image.png&originHeight=1384&originWidth=2496&size=185733&status=done&style=none&width=1248"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580276550045-7d46ea6d-c7f4-4916-aa1e-1e073c03fab7.png#align=left&display=inline&height=622&name=image.png&originHeight=1244&originWidth=2232&size=881348&status=done&style=none&width=1116"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580276609094-0e526664-816d-4383-83e8-366a06ed5f5e.png#align=left&display=inline&height=623&name=image.png&originHeight=1246&originWidth=2214&size=402740&status=done&style=none&width=1107"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580276710900-a1ba2337-c082-4fd1-9a34-fe6d6fe7c98e.png#align=left&display=inline&height=622&name=image.png&originHeight=1244&originWidth=2216&size=432044&status=done&style=none&width=1108"></p>
<h2 id="第-2-章-是什么？怎么用？何时用？如何不出问题？"><a href="#第-2-章-是什么？怎么用？何时用？如何不出问题？" class="headerlink" title="第 2 章 是什么？怎么用？何时用？如何不出问题？"></a>第 2 章 是什么？怎么用？何时用？如何不出问题？</h2><blockquote>
<p>手把手带着 Coding，解决基本概念、API 以及讲 4 个关键应用场景。以及工作中并发场景，如何不出问题。</p>
</blockquote>
<h3 id="2-1-ThreadLocal-是什么-07-41"><a href="#2-1-ThreadLocal-是什么-07-41" class="headerlink" title="2-1 ThreadLocal 是什么 (07:41)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21051">2-1 ThreadLocal 是什么 (07:41)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580288706984-af27ec24-eb3c-4f42-bfa4-fa13c6a6ec0f.png#align=left&display=inline&height=627&name=image.png&originHeight=1254&originWidth=2232&size=427456&status=done&style=none&width=1116"><br>一个进程有多个线程</p>
<p>定义：提供线程局部变量；一个线程局部变量在多个线程中，分别有独立的值（副本）</p>
<p>特点：简单（开箱即用）、快速（无额外开销）、安全（线程安全）</p>
<p>场景：多线程场景（资源持有、线程一致性、并发计算、线程安全等场景）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580288806795-24533713-bf54-4292-a3c5-c5d2c49a67ed.png#align=left&display=inline&height=619&name=image.png&originHeight=1238&originWidth=2216&size=255050&status=done&style=none&width=1108"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580288867098-1fb65509-be85-4b50-b451-9bb9d346b2bc.png#align=left&display=inline&height=619&name=image.png&originHeight=1238&originWidth=2126&size=458725&status=done&style=none&width=1063"></p>
<p>进程 -&gt; 线程表 -&gt; 线程局部变量</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580288980102-967ec446-b7d3-4666-b9d1-9649fa9fd0bb.png#align=left&display=inline&height=622&name=image.png&originHeight=1244&originWidth=2130&size=345881&status=done&style=none&width=1065"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580289036685-f40570c6-4594-4704-84a2-efd8dbff201e.png#align=left&display=inline&height=613&name=image.png&originHeight=1226&originWidth=2144&size=317384&status=done&style=none&width=1072"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580289099956-50937959-c293-4e59-835b-8a7724123a23.png#align=left&display=inline&height=616&name=image.png&originHeight=1232&originWidth=2212&size=189130&status=done&style=none&width=1106"></p>
<h3 id="2-2-ThreadLocal-基本-API-07-52"><a href="#2-2-ThreadLocal-基本-API-07-52" class="headerlink" title="2-2 ThreadLocal 基本 API (07:52)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21052">2-2 ThreadLocal 基本 API (07:52)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580289189869-ccc0bd89-aca7-4327-8445-f87599491497.png#align=left&display=inline&height=623&name=image.png&originHeight=1246&originWidth=2218&size=241348&status=done&style=none&width=1109"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Basic</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ThreadLocal&lt;T&gt;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; x = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Long&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Long <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Initial Value run..&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Thread.currentThread().getId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(x.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">        x.set(<span class="number">107L</span>);</span><br><span class="line">        <span class="comment">// 移除当前线程上的ThreadLocal的值</span></span><br><span class="line">        x.remove();</span><br><span class="line">         <span class="comment">/*</span></span><br><span class="line"><span class="comment">            get操作会延迟加载，如果不get,不会触发initialValue</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(x.get());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-ThreadLocal-的-4-种核心场景-07-51"><a href="#2-3-ThreadLocal-的-4-种核心场景-07-51" class="headerlink" title="2-3 ThreadLocal 的 4 种核心场景 (07:51)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21053">2-3 ThreadLocal 的 4 种核心场景 (07:51)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580290263718-4fb89baa-ad2f-429b-b9ac-eb94b60c9dc6.png#align=left&display=inline&height=627&name=image.png&originHeight=1254&originWidth=2224&size=501168&status=done&style=none&width=1112"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580290374565-e131ace0-780a-4e21-bd55-6fd1b8904103.png#align=left&display=inline&height=622&name=image.png&originHeight=1244&originWidth=2204&size=639857&status=done&style=none&width=1102"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580290441950-be7e1bdc-0dbc-4526-bd3f-3237912c493c.png#align=left&display=inline&height=622&name=image.png&originHeight=1244&originWidth=2206&size=727609&status=done&style=none&width=1103"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580290496982-ed04a47b-83d7-46a6-9929-50178a711b18.png#align=left&display=inline&height=619&name=image.png&originHeight=1238&originWidth=2220&size=819485&status=done&style=none&width=1110"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580290545374-3416923f-85e1-4714-8548-44c517809032.png#align=left&display=inline&height=615&name=image.png&originHeight=1230&originWidth=2202&size=502164&status=done&style=none&width=1101"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580290576400-243357b0-d684-4a52-8b14-c2e419a2678e.png#align=left&display=inline&height=618&name=image.png&originHeight=1236&originWidth=2202&size=197988&status=done&style=none&width=1101"><br>总结：</p>
<ul>
<li>持有资源——持有线程资源供线程的各个部分使用，全局获取，减少<strong>编程难度</strong></li>
<li>线程一致——帮助需要保持线程一致的资源（如数据库事务）维护一致性，降低<strong>编程难度</strong></li>
<li>线程安全——帮助只考虑了单线程的程序库，无缝向多线程场景迁移</li>
<li>分布式计算——帮助分布式计算场景的各个线程累计局部计算结果。</li>
</ul>
<h3 id="2-4-Thread-Local-并发场景分析-01-16-50"><a href="#2-4-Thread-Local-并发场景分析-01-16-50" class="headerlink" title="2-4 Thread Local 并发场景分析 01 (16:50)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21062">2-4 Thread Local 并发场景分析 01 (16:50)</a></h3><blockquote>
<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/gaohanghang/spring-threadlocal-demo">https://github.com/gaohanghang/spring-threadlocal-demo</a></p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580291505762-1356c133-268b-4682-810e-d08be5e7e06e.png#align=left&display=inline&height=612&name=image.png&originHeight=1224&originWidth=2220&size=337821&status=done&style=none&width=1110"></p>
<p>MAC 系统上安装 Apache ab 测试工具教程地址: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/cjsblog/p/10506647.html">https://www.cnblogs.com/cjsblog/p/10506647.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install apr</span><br><span class="line">brew install pcre</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/stat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">stat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">add</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        c++;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ab -n 10000 -c 1 localhost:8080/add</span><br><span class="line"></span><br><span class="line">curl localhost:8080/stat</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580314416673-2323b785-9537-45de-a473-44f1ac2f5092.png#align=left&display=inline&height=574&name=image.png&originHeight=1148&originWidth=2042&size=587690&status=done&style=none&width=1021"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580314502980-1a7d6b25-0e9c-402f-8b12-8816f9ec6167.png#align=left&display=inline&height=565&name=image.png&originHeight=1130&originWidth=2034&size=504701&status=done&style=none&width=1017"></p>
<p><strong>使用 Synchronized</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> <span class="keyword">void</span>  <span class="title function_">__add</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        c++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/stat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">stat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">add</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//Thread.sleep(100);</span></span><br><span class="line">        <span class="comment">//c++;</span></span><br><span class="line">        __add();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">使用synchronize后测试</span><br><span class="line"></span><br><span class="line">ab -n <span class="number">100</span> -c <span class="number">100</span> localhost:<span class="number">8080</span>/add</span><br><span class="line"></span><br><span class="line">curl localhost:<span class="number">8080</span>/stat</span><br></pre></td></tr></table></figure>

<p><strong>使用 ThreadLocal</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; c = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Integer <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">__add</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        c.set(c.get() + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/stat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">stat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> c.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">add</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        __add();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">使用ThreadLocal</span><br><span class="line"></span><br><span class="line">ab -n 10000 -c 100 localhost:8080/add</span><br><span class="line"></span><br><span class="line">curl localhost:8080/stat</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580315440114-b0080698-a2fd-4443-8558-2487fb855568.png#align=left&display=inline&height=569&name=image.png&originHeight=1138&originWidth=2032&size=281450&status=done&style=none&width=1016"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>基于线程池模型 synchronize（排队操作很<strong>危险</strong>）</li>
<li>用 ThreadLocal 收集数据很快且安全</li>
<li>思考：如何在多个 ThreadLocal 中收集数据？</li>
</ul>
<h3 id="2-5-ThreadLocal-场景分析——减少同步-10-10"><a href="#2-5-ThreadLocal-场景分析——减少同步-10-10" class="headerlink" title="2-5 ThreadLocal 场景分析——减少同步 (10:10)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21054">2-5 ThreadLocal 场景分析——减少同步 (10:10)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580316239145-3cf3dcf9-ffc9-4593-85a4-7bf84d7cce54.png#align=left&display=inline&height=572&name=image.png&originHeight=1144&originWidth=2044&size=397731&status=done&style=none&width=1022"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> HashSet&lt;Val&lt;Integer&gt;&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addSet</span><span class="params">(Val&lt;Integer&gt; v)</span> &#123;</span><br><span class="line">        set.add(v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ThreadLocal&lt;Val&lt;Integer&gt;&gt; c = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Val&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Val&lt;Integer&gt; <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            Val&lt;Integer&gt; v = <span class="keyword">new</span> <span class="title class_">Val</span>&lt;&gt;();</span><br><span class="line">            v.set(<span class="number">0</span>);</span><br><span class="line">            addSet(v);</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">__add</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        Val&lt;Integer&gt; v = c.get();</span><br><span class="line">        v.set(v.get() + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/stat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">stat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> set.stream().map(x -&gt; x.get()).reduce((a,x) -&gt; a+x).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">add</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        __add();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">使用ThreadLocal</span><br><span class="line"></span><br><span class="line">ab -n 10000 -c 100 localhost:8080/add</span><br><span class="line"></span><br><span class="line">ab -n 10000 -c 200 localhost:8080/add</span><br><span class="line"></span><br><span class="line">curl localhost:8080/stat</span><br></pre></td></tr></table></figure>

<h4 id="问题：set-add-v-为什么会有线程安全问题"><a href="#问题：set-add-v-为什么会有线程安全问题" class="headerlink" title="问题：set.add(v); 为什么会有线程安全问题"></a>问题：set.add(v); 为什么会有线程安全问题</h4><p>set 是所有线程共享的，是个临界区</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580319954534-1c4b8181-7003-4f21-ab7e-22d9148c42c4.png#align=left&display=inline&height=561&name=image.png&originHeight=1122&originWidth=2038&size=217511&status=done&style=none&width=1019"></p>
<h2 id="第-3-章-【极客视角】大神们怎么用-ThreadLocal-的"><a href="#第-3-章-【极客视角】大神们怎么用-ThreadLocal-的" class="headerlink" title="第 3 章 【极客视角】大神们怎么用 ThreadLocal 的"></a>第 3 章 【极客视角】大神们怎么用 ThreadLocal 的</h2><blockquote>
<p>挑选了 3 个 Java 领域影响深远的应用，Spring&#x2F;Mybatis&#x2F;Quartz 中使用到 ThreadLocal 的源码，理解大神们在思考什么，为什么会用到 ThreadLocal。</p>
</blockquote>
<h3 id="3-1-源码分析-1-Quartz-SimpleSemaphore-06-42"><a href="#3-1-源码分析-1-Quartz-SimpleSemaphore-06-42" class="headerlink" title=" 3-1 源码分析 1-Quartz SimpleSemaphore (06:42)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21055"> 3-1 源码分析 1-Quartz SimpleSemaphore (06:42)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580320024738-8c1014f4-f24a-4274-b43a-74f006e47871.png#align=left&display=inline&height=572&name=image.png&originHeight=1144&originWidth=2048&size=464595&status=done&style=none&width=1024"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580480597184-8bb00b4d-e4f0-4796-8661-c7776d4f4f69.png#align=left&display=inline&height=570&name=image.png&originHeight=1140&originWidth=2050&size=268257&status=done&style=none&width=1025"></p>
<h3 id="3-2-源码分析-2-Mybatis-框架保持连接池线程一致-04-46"><a href="#3-2-源码分析-2-Mybatis-框架保持连接池线程一致-04-46" class="headerlink" title=" 3-2 源码分析 2 Mybatis 框架保持连接池线程一致 (04:46)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21056"> 3-2 源码分析 2 Mybatis 框架保持连接池线程一致 (04:46)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580480656665-5c6b3bd2-7bbf-4f2f-9d79-1ebe7c9ddc5d.png#align=left&display=inline&height=569&name=image.png&originHeight=1138&originWidth=2046&size=238863&status=done&style=none&width=1023"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580480753798-b8dec9f9-38ac-47ee-918c-a8ff7a616f15.png#align=left&display=inline&height=562&name=image.png&originHeight=1124&originWidth=2014&size=592110&status=done&style=none&width=1007"></p>
<p>A（Atomic)）原子性，操作不可分割。<br>C（Consistency）一致性，任何时刻数据都能保持一致。<br>I（Isolation）隔离性，多事务并发执行的时序不影响结果。<br>D（Durability）持久性，对数据结构的存储是永久的。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580480809105-a612ddc6-692b-404d-9b57-7f06932b6714.png#align=left&display=inline&height=576&name=image.png&originHeight=1152&originWidth=2052&size=587009&status=done&style=none&width=1026"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580480908510-db46cae0-7703-4ed9-a8f6-73bcc643f3f1.png#align=left&display=inline&height=561&name=image.png&originHeight=1122&originWidth=2038&size=339832&status=done&style=none&width=1019"></p>
<h3 id="3-3-源码分析-03-Spring-框架对分布式事务的支持-04-03"><a href="#3-3-源码分析-03-Spring-框架对分布式事务的支持-04-03" class="headerlink" title=" 3-3 源码分析 03 Spring 框架对分布式事务的支持 (04:03)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21057"> 3-3 源码分析 03 Spring 框架对分布式事务的支持 (04:03)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580480937973-1f716eb7-0cac-4e20-9859-84a14022418a.png#align=left&display=inline&height=576&name=image.png&originHeight=1152&originWidth=2060&size=309429&status=done&style=none&width=1030"></p>
<p>A（Atomic)）原子性，操作不可分割。<br>C（Consistency）一致性，任何时刻数据都能保持一致。<br>I（Isolation）隔离性，多事务并发执行的时序不影响结果。<br>D（Durability）持久性，对数据结构的存储是永久的。</p>
<p>A：要么发生，要么不发生<br>C：要做对，做错了不算<br>I：同时发生两个事务，两个事务的结果能够叠加的一致，同时扣款<br>D：数据要被持久化下来</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580480961117-7fc34b99-03cc-415d-9e70-bbcfae2fa3ba.png#align=left&display=inline&height=571&name=image.png&originHeight=1142&originWidth=2028&size=625709&status=done&style=none&width=1014"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580481510627-18f0f872-f9ac-47e1-8ea3-b741be7cb046.png#align=left&display=inline&height=570&name=image.png&originHeight=1140&originWidth=2052&size=762508&status=done&style=none&width=1026"></p>
<p>context 环境</p>
<h2 id="第-4-章-【设计者视角】源码级实现-amp-源码分析"><a href="#第-4-章-【设计者视角】源码级实现-amp-源码分析" class="headerlink" title="第 4 章 【设计者视角】源码级实现&amp;源码分析"></a>第 4 章 【设计者视角】源码级实现&amp;源码分析</h2><h3 id="4-1-实现自己的-ThreadLocal-12-16"><a href="#4-1-实现自己的-ThreadLocal-12-16" class="headerlink" title="4-1 实现自己的 ThreadLocal (12:16)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21058">4-1 实现自己的 ThreadLocal (12:16)</a></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 共享空间</span></span><br><span class="line">    <span class="keyword">static</span> HashMap&lt;Thread, HashMap&lt;MyThreadLocal&lt;?&gt;, Object&gt;&gt; threadLocalMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前线程的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">synchronized</span> <span class="keyword">static</span> HashMap&lt;MyThreadLocal&lt;?&gt;, Object&gt; getMap() &#123;</span><br><span class="line">        <span class="comment">// 获取当前线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="comment">// 判断threadLocalMap是否包含当前线程，不包含就put进去</span></span><br><span class="line">        <span class="keyword">if</span> (!threadLocalMap.containsKey(thread)) &#123;</span><br><span class="line">            threadLocalMap.put(thread, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;MyThreadLocal&lt;?&gt;,Object&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取当前thread的map</span></span><br><span class="line">        <span class="keyword">return</span> threadLocalMap.get(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;MyThreadLocal&lt;?&gt;, Object&gt; map = getMap();</span><br><span class="line">        <span class="keyword">if</span> (!map.containsKey(<span class="built_in">this</span>)) &#123;</span><br><span class="line">            map.put(<span class="built_in">this</span>, initialValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) map.get(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T v)</span> &#123;</span><br><span class="line">        HashMap&lt;MyThreadLocal&lt;?&gt;, Object&gt; map = getMap();</span><br><span class="line">        map.put(<span class="built_in">this</span>, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> MyThreadLocal&lt;Long&gt; v = <span class="keyword">new</span> <span class="title class_">MyThreadLocal</span>&lt;Long&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Long <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Thread.currentThread().getId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                System.out.println(v.get());</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580483675589-0a208adc-46ae-4fff-9ebd-fc64c02dc357.png#align=left&display=inline&height=568&name=image.png&originHeight=1136&originWidth=2038&size=229596&status=done&style=none&width=1019"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580483873261-c5a9c11e-4bce-4036-ba6b-83c1be8d2354.png#align=left&display=inline&height=562&name=image.png&originHeight=1124&originWidth=2010&size=720211&status=done&style=none&width=1005"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">atomic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自增</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">threadLocalHash</span> <span class="operator">=</span> atomic.addAndGet(<span class="number">0x61c88647</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 共享空间</span></span><br><span class="line">    <span class="keyword">static</span> HashMap&lt;Thread, HashMap&lt;Integer, Object&gt;&gt; threadLocalMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前线程的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">synchronized</span> <span class="keyword">static</span> HashMap&lt;Integer, Object&gt; <span class="title function_">getMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="comment">// 判断threadLocalMap是否包含当前线程，不包含就put进去</span></span><br><span class="line">        <span class="keyword">if</span> (!threadLocalMap.containsKey(thread)) &#123;</span><br><span class="line">            threadLocalMap.put(thread, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Integer,Object&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取当前thread的map</span></span><br><span class="line">        <span class="keyword">return</span> threadLocalMap.get(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;Integer, Object&gt; map = getMap();</span><br><span class="line">        <span class="keyword">if</span> (!map.containsKey(<span class="built_in">this</span>.threadLocalHash)) &#123;</span><br><span class="line">            map.put(<span class="built_in">this</span>.threadLocalHash, initialValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) map.get(<span class="built_in">this</span>.threadLocalHash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T v)</span> &#123;</span><br><span class="line">        HashMap&lt;Integer, Object&gt; map = getMap();</span><br><span class="line">        map.put(<span class="built_in">this</span>.threadLocalHash, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484136537-c1e80f1c-939c-46af-822b-125c74f57e87.png#align=left&display=inline&height=562&name=image.png&originHeight=1124&originWidth=2030&size=169190&status=done&style=none&width=1015"></p>
<h3 id="4-2-选学-HashTable-03-56"><a href="#4-2-选学-HashTable-03-56" class="headerlink" title="4-2 选学 HashTable (03:56)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21059">4-2 选学 HashTable (03:56)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484171303-3d7e5aad-5624-4c77-a432-d53884ae6737.png#align=left&display=inline&height=565&name=image.png&originHeight=1130&originWidth=2052&size=232707&status=done&style=none&width=1026"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484200988-5e508785-cccc-487a-ad6d-698632751a1d.png#align=left&display=inline&height=566&name=image.png&originHeight=1132&originWidth=2048&size=239436&status=done&style=none&width=1024"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484218568-c47dc413-cbe5-43e2-a3f6-dfd9eec12227.png#align=left&display=inline&height=569&name=image.png&originHeight=1138&originWidth=2036&size=291317&status=done&style=none&width=1018"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484285123-0481a94d-58fb-49a9-a2c4-5b8335bed850.png#align=left&display=inline&height=563&name=image.png&originHeight=1126&originWidth=2032&size=446459&status=done&style=none&width=1016"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484301949-0ed0c2c5-a3ee-401a-8542-732db42768d4.png#align=left&display=inline&height=569&name=image.png&originHeight=1138&originWidth=2030&size=459263&status=done&style=none&width=1015"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484324800-3a373548-7256-4ca1-97fa-46820e84226e.png#align=left&display=inline&height=566&name=image.png&originHeight=1132&originWidth=2018&size=591886&status=done&style=none&width=1009"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484354861-5a2a1f16-43f7-4717-8bec-d27620b84862.png#align=left&display=inline&height=563&name=image.png&originHeight=1126&originWidth=2028&size=292298&status=done&style=none&width=1014"></p>
<h3 id="4-3-ThreadLocal-源码分析-13-40"><a href="#4-3-ThreadLocal-源码分析-13-40" class="headerlink" title="4-3 ThreadLocal 源码分析 (13:40)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21060">4-3 ThreadLocal 源码分析 (13:40)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484527702-28ef0410-e0a0-46f5-adc2-5a90bfd24970.png#align=left&display=inline&height=557&name=image.png&originHeight=1114&originWidth=2020&size=107860&status=done&style=none&width=1010"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484551012-d5ea7531-350f-417c-891c-6c4ba5263ce1.png#align=left&display=inline&height=573&name=image.png&originHeight=1146&originWidth=2046&size=213460&status=done&style=none&width=1023"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580484900463-724b011e-2896-4b41-9e64-d08e64cc3d2c.png#align=left&display=inline&height=573&name=image.png&originHeight=1146&originWidth=2014&size=240650&status=done&style=none&width=1007"></p>
<h2 id="第-5-章-全课总结"><a href="#第-5-章-全课总结" class="headerlink" title="第 5 章 全课总结"></a>第 5 章 全课总结</h2><blockquote>
<p>ThreadLocal 只是一个简单的数据结构，却引出了这么多问题，可见真理常常隐藏在容易忽视微小的地方，优秀的程序员不仅仅要大局观强，还更加需要磨砺细节——和老师一起思考未来应该怎样学习？</p>
</blockquote>
<h3 id="5-1-总结-04-19"><a href="#5-1-总结-04-19" class="headerlink" title="5-1 总结 (04:19)"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/video/21061">5-1 总结 (04:19)</a></h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580485337565-f31c40ff-b84a-4f33-8ff8-b628202e48cb.png#align=left&display=inline&height=567&name=image.png&originHeight=1134&originWidth=2026&size=420477&status=done&style=none&width=1013"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580485355830-3090a27d-a641-4676-8fad-220822d83e49.png#align=left&display=inline&height=576&name=image.png&originHeight=1152&originWidth=2040&size=413193&status=done&style=none&width=1020"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580485395229-eb215f77-bc45-478d-899f-3460dad5e68f.png#align=left&display=inline&height=568&name=image.png&originHeight=1136&originWidth=2048&size=312242&status=done&style=none&width=1024"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/576791/1580485432351-6d32dcca-bba4-4724-9ef2-c128268f4c86.png#align=left&display=inline&height=566&name=image.png&originHeight=1132&originWidth=2054&size=241653&status=done&style=none&width=1027"></p>
<h4 id="一些建议"><a href="#一些建议" class="headerlink" title="一些建议"></a>一些建议</h4><ul>
<li>无论将来到什么样的高度，永远认为自己是个菜鸡：总有比我们厉害的大牛，永远都去学习</li>
<li>保持兴趣，体会乐趣：投入在工作上的时间是很多的，在工作上一定要保持兴趣</li>
<li>技术创造是有价值的（切记）：自己尝试去创造，尝试学新东西去用</li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><blockquote>
<p>首先感谢大佬的课程分享，通过课程学到了很多东西</p>
<p>另外是我有个公众号，叫《骇客与画家》，欢迎大家来关注 😆</p>
<p>骇客与画家，名称来自书籍《黑客与画家》，画家学习绘画的方法是动手去画，骇客学习编程的方法也是动手去实践</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2019/png/576791/1577433516700-202fdc3d-5019-4324-ae77-b7be287cc9a7.png#align=left&display=inline&height=500&name=image.png&originHeight=500&originWidth=900&size=177089&status=done&style=none&width=900"></p>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://gaohanghang.cn/2020/02/01/%E6%85%95%E8%AF%BE%E7%BD%91-ThreadLocal-%E6%95%99%E5%AD%A6%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2020/02/16/%E6%88%91%E5%BE%88%E6%97%A0%E8%81%8A%EF%BC%8C%E8%AF%A5%E6%80%8E%E4%B9%88%E5%8A%9E/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            我很无聊，该怎么办
          
        </div>
      </a>
    
    
      <a href="/2020/01/19/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E4%B8%A4%E4%B8%AA%E7%BA%BF%E7%A8%8B%E4%BA%A4%E6%9B%BF%E6%89%93%E5%8D%B01-100%EF%BC%9F/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">如何使用两个线程交替打印1--100？</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2023
        <i class="ri-heart-fill heart_icon"></i> 高行行
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="高行行的个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="http://gaohanghang.lofter.com">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/twitter">Twitter</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://weibo.com/u/5125203090">微博</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>